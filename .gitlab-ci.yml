image: oarteam/batsim_ci:latest

variables:
  GIT_SUBMODULE_STRATEGY: none

stages:
  - big_stage

###############################################################################
# Build and test
###############################################################################
build_and_test:
  stage: big_stage
  script:
    #-------------#
    # C++ library #
    #-------------#
    # - nix-shell --pure -A batprotocol-cpp --command '.ci/list-store-paths-for-cachix.bash' | cachix push batsim
    # - nix-build -A batprotocol-cpp
    - nix flake show
    - nix build .#batprotocol-cpp
    - nix build .#ci-batprotocol-cpp-werror-gcc
    #- nix build .#ci-batprotocol-cpp-werror-clang
    # tests
    - nix build .#ci-cpp-test
    - nix build -o result-cov-report .#ci-cpp-coverage-report
    - cat ./result-cov-report/file-summary.txt
    #----------------#
    # Python library #
    #----------------#
    # - nix-build -A batprotocol-py
